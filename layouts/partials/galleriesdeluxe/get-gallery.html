{{ $gallery := dict "images" (slice) }}

{{ $images := slice }}
{{ if eq .Layout "from-text-file" }}
  {{ $imagesList := .Resources.GetMatch "images.txt" }}
  {{ if $imagesList }}
    {{ $imagesURLs := split $imagesList.Content "\n" }}
    {{ range $imagesURLs }}
      {{ with try (resources.GetRemote .) }}
        {{ with .Err }}
          {{ warnf "Error fetching %s: %s" . .Err }}
        {{ else with .Value }}
          {{ $img := . | resources.Copy (printf "%s%s" $.File.Dir .Name) }}
          {{ $images = $images | append $img }}
        {{ else }}
          {{ warnf "Unable to get remote resource %q" . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ else }}
    {{ warnf "No images.txt found for %s" .RelPermalink }}
  {{ end }}
{{ else if eq .Kind "term" }}
  {{ range .Pages }}
    {{ with partial "galleriesdeluxe/get-gallery.html" . }}
      {{ $images = $images | append .images }}
    {{ end }}
  {{ end }}
{{ else }}
  {{ $images = (.Resources.ByType "image") }}
{{ end }}

{{ with $images }}
  {{ $id := $.RelPermalink | hash.FNV32a }}
  {{ $idx :=  mod $id (len $images) }}
  {{ $first := index $images $idx }}
  {{ $thumb := $first.Fill "400x264 smart" }}
  {{ $gallery = dict
    "page" $
    "images" $images
    "thumb" $thumb
    "first" $.Params.first
  }}
{{ end }}
{{ return $gallery }}
